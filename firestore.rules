/**
 * @fileoverview Firestore Security Rules for Spoton application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and their associated playlists and pins.
 * Tracks are treated as public read-only data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data. Access is restricted to the user themselves.
 * - /users/{userId}/playlists/{playlistId}: Stores playlists created by each user. Access is restricted to the owning user.
 * - /users/{userId}/pins/{pinId}: Stores pinned items for each user. Access is restricted to the owning user.
 * - /tracks/{trackId}: Stores track metadata. Publicly readable.
 *
 * Key Security Decisions:
 * - Users can only access their own profile data, playlists, and pins. Listing other users' playlists or pins is not permitted.
 * - Tracks are publicly readable, but write access is denied to everyone.
 *
 * Denormalization for Authorization:
 *  This ruleset does not require denormalization.  Authorization is derived from `request.auth.uid` and path-based ownership.
 *
 * Structural Segregation:
 *  User-specific data (profiles, playlists, pins) is stored under the /users/{userId} path, ensuring private access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @return {boolean} - True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the owner of an existing resource.
     *              Combines ownership check with existence check.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @return {boolean} - True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(resource);
    }

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} - True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for user playlists.
     * @path /users/{userId}/playlists/{playlistId}
     */
    match /users/{userId}/playlists/{playlistId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for user pins.
     * @path /users/{userId}/pins/{pinId}
     */
    match /users/{userId}/pins/{pinId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for tracks.  Tracks are publicly readable.
     * @path /tracks/{trackId}
     */
    match /tracks/{trackId} {
      allow get: if true;
      allow list: if true;
    }
  }
}