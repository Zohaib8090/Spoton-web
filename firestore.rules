/**
 * @fileoverview Firestore Security Rules for HarmonyStream.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles, playlists, and pinned items,
 * and allows public read access to track metadata.  All write operations require a valid,
 * authenticated user.  Data validation is minimized to allow for rapid prototyping.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information, accessible only to the user.
 * - /users/{userId}/playlists/{playlistId}: Stores user-created playlists, accessible only to the user.
 * - /users/{userId}/pins/{pinId}: Stores user's pinned items, accessible only to the user.
 * - /tracks/{trackId}: Stores track metadata, publicly readable but not writable by clients.
 *
 * Key Security Decisions:
 * - User listing is disabled for privacy.
 * - Track data is publicly readable to facilitate discovery, but write access is not granted by these rules.
 * - Rules are designed to avoid `get()` calls for performance and cost efficiency by denormalizing authorization data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles.  Users can only read/write their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete) if the user's ID matches the document ID.
     * @deny (create, update, delete) if the user's ID does not match the document ID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted.
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects playlists created by a user. Each user can only read/write their own playlists.
     * @path /users/{userId}/playlists/{playlistId}
     * @allow (create, update, delete) if the user's ID matches the userId path.
     * @deny (create, update, delete) if the user's ID does not match the userId path.
     * @principle Enforces document ownership for writes, path-based access control.
     */
    match /users/{userId}/playlists/{playlistId} {
        function isOwner(userId) {
            return request.auth != null && request.auth.uid == userId;
        }

        function isSignedIn() {
            return request.auth != null;
        }

        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
    }

    /**
     * @description Protects pinned items (songs, albums, playlists) for each user.
     * @path /users/{userId}/pins/{pinId}
     * @allow (create, update, delete) if the user's ID matches the userId path.
     * @deny (create, update, delete) if the user's ID does not match the userId path.
     * @principle Enforces document ownership for writes, path-based access control.
     */
     match /users/{userId}/pins/{pinId} {
        function isOwner(userId) {
            return request.auth != null && request.auth.uid == userId;
        }

        function isSignedIn() {
            return request.auth != null;
        }

        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to track metadata.
     * @path /tracks/{trackId}
     * @allow get, list: if true;
     * @deny create, update, delete: always.
     * @principle Public read, owner-only writes (no owner, so writes are disabled).
     */
    match /tracks/{trackId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}